<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Reds Squad Hub - Liverpool FC</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 50%, #c8102e 100%);
      background-attachment: fixed;
      color: white;
      overflow-x: hidden;
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: #0f0f1a;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
    }
    .logo-section:hover {
      opacity: 0.8;
    }
    .logo {
      width: 50px;
      height: 50px;
      background: transparent;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .header h1 {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 2px;
    }
    .nav-menu {
      display: flex;
      align-items: center;
      gap: 30px;
      flex: 1;
      justify-content: center;
    }
    .nav-link {
      color: #888;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .nav-link:hover, .nav-link.active {
      color: #00b2a9;
    }
    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .user-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #252535;
      padding: 8px 15px;
      border-radius: 25px;
    }
    .user-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #00b2a9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .logout-btn {
      background: transparent;
      border: 1px solid #c8102e;
      color: #c8102e;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .logout-btn:hover {
      background: #c8102e;
      color: white;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }

    /* Controls */
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    .search-box input {
      width: 100%;
      padding: 12px 40px 12px 15px;
      background: #252535;
      border: 2px solid #333345;
      border-radius: 10px;
      color: white;
      font-size: 14px;
    }
    .search-box input:focus {
      outline: none;
      border-color: #00b2a9;
    }
    .formation-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .formation-btn {
      background: #252535;
      border: 2px solid #333345;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .formation-btn.active {
      background: #00b2a9;
      border-color: #00b2a9;
    }
    .formation-btn:hover {
      border-color: #00b2a9;
    }
    .save-lineup-btn {
      background: #c8102e;
      border: none;
      color: white;
      padding: 10px 25px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.5;
      cursor: not-allowed;
    }
    .save-lineup-btn.enabled {
      opacity: 1;
      cursor: pointer;
    }
    .save-lineup-btn.enabled:hover {
      background: #a00d24;
      transform: translateY(-2px);
    }
    .history-dropdown {
      position: relative;
    }
    .history-btn {
      background: #252535;
      border: 2px solid #333345;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-btn:hover {
      border-color: #00b2a9;
    }
    .history-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 10px;
      background: #252535;
      border: 2px solid #333345;
      border-radius: 10px;
      min-width: 300px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    .history-menu.show {
      display: block;
    }
    .history-item {
      padding: 15px;
      border-bottom: 1px solid #333345;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .history-item:hover {
      background: #1a1a2e;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-item-content {
      flex: 1;
      cursor: pointer;
    }
    .history-item-title {
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    .history-item-date {
      font-size: 12px;
      color: #888;
    }
    .history-item-delete {
      background: transparent;
      border: 1px solid #c8102e;
      color: #c8102e;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .history-item-delete:hover {
      background: #c8102e;
      color: white;
    }
    .history-empty {
      padding: 20px;
      text-align: center;
      color: #888;
    }

    /* Main Content Layout */
    .main-content {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    /* Football Pitch */
    .pitch-container {
      flex: 1;
      min-width: 600px;
      background: #252535;
      border-radius: 20px;
      padding: 20px 20px 50px 20px; /* Extra padding at bottom for player names */
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    .pitch {
      width: 100%;
      max-width: 900px;
      height: 0;
      padding-bottom: 85%; /* Extended pitch ratio to give more space at bottom */
      background: linear-gradient(to bottom, #2ecc71 0%, #27ae60 50%, #2ecc71 100%);
      border-radius: 15px;
      position: relative;
      overflow: visible; /* Changed to visible so player names can extend beyond */
      border: 5px solid #fff;
      margin: 0 auto;
    }
    
    /* Pitch lines */
    .pitch::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(255,255,255,0.5);
      transform: translateY(-50%);
    }
    .pitch::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120px;
      height: 120px;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 50%;
    }
    .center-spot {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: rgba(255,255,255,0.7);
      border-radius: 50%;
      z-index: 1;
    }
    .penalty-area {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 120px;
      border: 2px solid rgba(255,255,255,0.4);
    }
    .penalty-area.top {
      top: 0;
      border-top: none;
    }
    .penalty-area.bottom {
      bottom: 0;
      border-bottom: none;
    }

    /* Formation Positions */
    .formation-grid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 20px 20px 40px 20px; /* Extra padding at bottom for player names */
    }
    .position-slot {
      position: absolute;
      width: 70px;
      height: 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform: translate(-50%, -50%);
      transition: all 0.3s;
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
    }
    .position-slot.occupied {
      cursor: grab;
      border: 2px solid rgba(0,178,169,0.3);
      background: transparent;
    }
    .position-slot.occupied:active {
      cursor: grabbing;
    }
    .position-slot.drag-over {
      transform: translate(-50%, -50%) scale(1.1);
      border-color: #00b2a9;
      background: rgba(0,178,169,0.2);
    }
    .player-shirt {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      border: 3px solid #00b2a9;
      background: linear-gradient(180deg, #1a1a2e 0%, #252535 100%);
      overflow: hidden;
    }
    .player-shirt img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 5px;
    }
    .player-shirt:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 6px 15px rgba(0,178,169,0.5);
      border-color: #00b2a9;
    }
    .player-shirt.dragging {
      opacity: 0.5;
    }
    .no-player-img {
      font-size: 35px;
      color: rgba(255,255,255,0.3);
    }
    .player-name {
      font-size: 11px;
      color: white;
      text-align: center;
      margin-top: 5px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70px;
    }
    .empty-slot {
      width: 70px;
      height: 70px;
      border: 3px dashed rgba(255,255,255,0.4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.5);
      font-size: 32px;
      transition: all 0.3s;
      background: rgba(255,255,255,0.05);
    }
    .empty-slot:hover {
      border-color: #00b2a9;
      background: rgba(0,178,169,0.1);
      color: #00b2a9;
    }
    .empty-slot.drag-over {
      border-color: #00b2a9;
      background: rgba(0,178,169,0.2);
    }

    /* Bench Section */
    .bench-container {
      width: 100%;
      background: #252535;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    .bench-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .bench-title {
      font-size: 18px;
      font-weight: 600;
      color: #00b2a9;
    }
    .position-filter {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: transparent;
      border: 1px solid #333345;
      color: #888;
      padding: 5px 12px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    .filter-btn.active {
      background: #00b2a9;
      border-color: #00b2a9;
      color: white;
    }
    .filter-btn:hover {
      border-color: #00b2a9;
    }
    .bench-grid {
      display: grid;
      grid-template-columns: repeat(2, 150px);
      gap: 8px;
      min-height: 400px;
      padding: 10px;
      background: #1a1a2e;
      border-radius: 15px;
      max-height: 600px;
      overflow-y: auto;
      justify-content: center;
      align-content: start;
    }
    .bench-player {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: grab;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .bench-player:active {
      cursor: grabbing;
    }
    .bench-player.dragging {
      opacity: 0.5;
    }
    .player-card {
      background: #252535;
      border-radius: 15px;
      padding: 8px;
      width: 150px;
      max-width: 150px;
      min-width: 150px;
      text-align: center;
      border: 2px solid #333345;
      transition: all 0.3s;
      box-sizing: border-box;
    }
    .player-card:hover {
      border-color: #00b2a9;
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,178,169,0.3);
    }
    .player-card .player-photo-mini {
      width: 65px;
      height: 65px;
      margin: 0 auto 6px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #00b2a9;
      background: linear-gradient(180deg, #1a1a2e 0%, #252535 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .player-card .player-photo-mini img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 5px;
    }
    .player-card .no-photo-icon {
      font-size: 40px;
      color: rgba(255,255,255,0.2);
    }
    .player-card .player-info {
      color: white;
    }
    .player-card .player-info .name {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 3px;
    }
    .player-card .player-info .position {
      font-size: 10px;
      color: #00b2a9;
      font-weight: 600;
      background: rgba(0,178,169,0.1);
      padding: 2px 6px;
      border-radius: 8px;
      display: inline-block;
    }
    .player-card .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #333345;
      font-size: 9px;
    }
    .player-card .stat {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .player-card .stat-label {
      color: #888;
    }
    .player-card .stat-value {
      color: white;
      font-weight: 600;
    }

    /* Info Panel */
    .info-panel {
      width: 350px;
      background: #252535;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    .info-header {
      font-size: 18px;
      font-weight: 600;
      color: #00b2a9;
      margin-bottom: 15px;
    }
    .formation-info {
      background: #1a1a2e;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #333345;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      color: #888;
      font-size: 14px;
    }
    .info-value {
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    .goalkeeper-badge {
      color: #f39c12;
    }
    .defender-badge {
      color: #3498db;
    }
    .midfielder-badge {
      color: #2ecc71;
    }
    .forward-badge {
      color: #e74c3c;
    }

    /* Scrollbar */
    .bench-grid::-webkit-scrollbar {
      width: 8px;
    }
    .bench-grid::-webkit-scrollbar-track {
      background: #1a1a2e;
      border-radius: 10px;
    }
    .bench-grid::-webkit-scrollbar-thumb {
      background: #00b2a9;
      border-radius: 10px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .info-panel {
        width: 100% !important;
      }
      .main-content {
        flex-direction: column;
      }
      .nav-menu {
        gap: 15px;
      }
      .bench-grid {
        justify-content: center;
      }
    }
    @media (max-width: 768px) {
      .pitch-container {
        min-width: 100%;
      }
      .player-card {
        width: 120px;
      }
      .header {
        flex-wrap: wrap;
        gap: 15px;
      }
      .nav-menu {
        order: 3;
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <a href="/" style="text-decoration: none; color: inherit;">
      <div class="logo-section">
        <div class="logo">
          <img src="/image/logo.png" alt="LFC Logo">
        </div>
        <h1>Liverpool Fan Page - Group 30</h1>
      </div>
    </a>
    <div class="nav-menu">
      <a href="/" class="nav-link">Home</a>
      <a href="/squad" class="nav-link active">Line-up Prediction</a>
      <a href="/players" class="nav-link">Players</a>
    </div>
    <div class="user-section">
      <div class="user-badge">
        <div class="user-avatar">
          <%= user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U' %>
        </div>
        <span><%= user.displayName || user.email %></span>
      </div>
      <form action="/logout" method="GET">
        <button type="submit" class="logout-btn">LOGOUT</button>
      </form>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Controls -->
    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search players by name, position, nationality, or tags...">
      </div>
      <div class="formation-selector">
        <span style="color: #888; font-size: 14px;">Formation:</span>
        <button class="formation-btn active" data-formation="4-2-3-1">4-2-3-1</button>
      </div>
      <div class="history-dropdown">
        <button class="history-btn" id="historyBtn">
          <span>üìã</span> HISTORY
        </button>
        <div class="history-menu" id="historyMenu">
          <!-- History items will be loaded here -->
        </div>
      </div>
      <button class="save-lineup-btn" id="saveLineupBtn">
        <span>üíæ</span> SAVE LINEUP
      </button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Pitch Container -->
      <div class="pitch-container">
        <div class="pitch">
          <div class="center-spot"></div>
          <div class="penalty-area top"></div>
          <div class="penalty-area bottom"></div>
          <div class="formation-grid" id="pitchGrid">
            <!-- Positions will be dynamically generated -->
          </div>
        </div>
      </div>

      <!-- Bench Section (moved to sidebar) -->
      <div class="info-panel" style="width: 360px; max-width: 360px; min-width: 360px;">
        <div class="bench-header">
          <div class="bench-title">ü™ë BENCH & AVAILABLE PLAYERS</div>
          <div class="position-filter">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="Goalkeeper">GK</button>
            <button class="filter-btn" data-filter="Defender">DEF</button>
            <button class="filter-btn" data-filter="Midfielder">MID</button>
            <button class="filter-btn" data-filter="Forward">FWD</button>
          </div>
        </div>
        <div class="bench-grid" id="benchGrid" style="max-height: 700px; min-height: 400px;">
          <!-- Players will be dynamically generated -->
        </div>
      </div>
    </div>

    <!-- Squad Overview (moved to bottom) -->
    <div class="bench-container" style="margin-top: 20px;">
      <div class="info-header" style="font-size: 18px; font-weight: 600; color: #00b2a9; margin-bottom: 15px;">Squad Overview</div>
      <div class="formation-info" style="background: #1a1a2e; border-radius: 15px; padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div class="info-row" style="border: none;">
          <span class="info-label">Formation</span>
          <span class="info-value" id="currentFormation">4-2-3-1</span>
        </div>
        <div class="info-row" style="border: none;">
          <span class="info-label">Players on Pitch</span>
          <span class="info-value"><span id="pitchCount">0</span> / 11</span>
        </div>
        <div class="info-row" style="border: none;">
          <span class="info-label goalkeeper-badge">‚¨§ Goalkeeper</span>
          <span class="info-value" id="gkCount">0</span>
        </div>
        <div class="info-row" style="border: none;">
          <span class="info-label defender-badge">‚¨§ Defenders</span>
          <span class="info-value" id="defCount">0</span>
        </div>
        <div class="info-row" style="border: none;">
          <span class="info-label midfielder-badge">‚¨§ Midfielders</span>
          <span class="info-value" id="midCount">0</span>
        </div>
        <div class="info-row" style="border: none;">
          <span class="info-label forward-badge">‚¨§ Forwards</span>
          <span class="info-value" id="fwdCount">0</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Player data from server
    const allPlayers = <%- JSON.stringify(players) %>;
    
    // Formation configurations - Changed to use OUTFIELD for non-GK positions
    const formations = {
      '4-2-3-1': {
        GK: [{ x: 50, y: 90 }], // Moved up from 95 to 90 to give space for name
        OUTFIELD: [
          // Defenders
          { x: 20, y: 72 },
          { x: 40, y: 72 },
          { x: 60, y: 72 },
          { x: 80, y: 72 },
          // Defensive Midfielders
          { x: 35, y: 57 },
          { x: 65, y: 57 },
          // Attacking Midfielders
          { x: 25, y: 38 },
          { x: 50, y: 33 },
          { x: 75, y: 38 },
          // Forward
          { x: 50, y: 13 }
        ]
      }
    };

    // Current state
    let currentFormation = '4-2-3-1';
    let pitchPlayers = {}; // { position: playerId }
    let benchPlayers = [...allPlayers];
    let currentFilter = 'all';
    let draggedPlayer = null;
    let draggedFromPosition = null;

    // Position mapping
    const positionMap = {
      'Goalkeeper': 'GK',
      'Defender': 'DEF',
      'Midfielder': 'MID',
      'Forward': 'FWD'
    };

    // Initialize
    function init() {
      renderPitch();
      renderBench();
      updateStats();
      attachEventListeners();
    }

    // Render pitch positions
    function renderPitch() {
      const pitchGrid = document.getElementById('pitchGrid');
      pitchGrid.innerHTML = '';
      
      const formation = formations[currentFormation];
      let positionIndex = 0;

      Object.entries(formation).forEach(([role, positions]) => {
        positions.forEach(pos => {
          const slot = document.createElement('div');
          slot.className = 'position-slot';
          slot.style.left = pos.x + '%';
          slot.style.top = pos.y + '%';
          slot.dataset.position = positionIndex;
          slot.dataset.role = role;

          const player = pitchPlayers[positionIndex];
          if (player) {
            slot.classList.add('occupied');
            const photoPath = player.squadNumber ? `/players_image/${player.squadNumber}.png` : null;
            slot.innerHTML = `
              <div class="player-shirt" draggable="true">
                ${photoPath ? `
                  <img src="${photoPath}" alt="${player.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                  <div class="no-player-img" style="display: none;">‚öΩ</div>
                ` : `
                  <div class="no-player-img">‚öΩ</div>
                `}
              </div>
              <div class="player-name">${player.name.split(' ').pop()}</div>
            `;
          } else {
            slot.innerHTML = `<div class="empty-slot">+</div>`;
          }

          // Drag events for pitch
          slot.addEventListener('dragover', handleDragOver);
          slot.addEventListener('drop', handleDrop);
          slot.addEventListener('dragleave', handleDragLeave);
          
          if (player) {
            const shirt = slot.querySelector('.player-shirt');
            shirt.addEventListener('dragstart', (e) => handleDragStart(e, player, positionIndex));
            shirt.addEventListener('dragend', handleDragEnd);
            shirt.addEventListener('click', () => window.location.href = `/details?_id=${player._id}`);
          }

          pitchGrid.appendChild(slot);
          positionIndex++;
        });
      });
    }

    // Render bench
    function renderBench() {
      const benchGrid = document.getElementById('benchGrid');
      benchGrid.innerHTML = '';

      const filteredPlayers = currentFilter === 'all' 
        ? benchPlayers 
        : benchPlayers.filter(p => p.position === currentFilter);

      // Apply search filter
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const displayPlayers = filteredPlayers.filter(player => {
        return player.name.toLowerCase().includes(searchTerm) ||
               player.position.toLowerCase().includes(searchTerm) ||
               player.nationality.toLowerCase().includes(searchTerm) ||
               (player.tags && player.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
      });

      displayPlayers.forEach(player => {
        const card = document.createElement('div');
        card.className = 'bench-player';
        card.draggable = true;
        
        const photoPath = player.squadNumber ? `/players_image/${player.squadNumber}.png` : null;
        
        card.innerHTML = `
          <div class="player-card">
            <div class="player-photo-mini">
              ${photoPath ? `
                <img src="${photoPath}" alt="${player.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                <div class="no-photo-icon" style="display: none;">‚öΩ</div>
              ` : `
                <div class="no-photo-icon">‚öΩ</div>
              `}
            </div>
            <div class="player-info">
              <div class="name">${player.name}</div>
              <div class="position">${player.position}</div>
            </div>
            <div class="stats">
              <div class="stat">
                <span class="stat-label">Apps</span>
                <span class="stat-value">${player.stats ? player.stats.appearances : 0}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Goals</span>
                <span class="stat-value">${player.stats ? player.stats.goals : 0}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Assists</span>
                <span class="stat-value">${player.stats ? player.stats.assists : 0}</span>
              </div>
            </div>
          </div>
        `;

        card.addEventListener('dragstart', (e) => handleDragStart(e, player, null));
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('click', () => window.location.href = `/details?_id=${player._id}`);

        benchGrid.appendChild(card);
      });
    }

    // Drag handlers
    function handleDragStart(e, player, fromPosition) {
      draggedPlayer = player;
      draggedFromPosition = fromPosition;
      e.target.closest('[draggable]').classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
      e.target.closest('[draggable]').classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const slot = e.currentTarget;
      
      if (!draggedPlayer) return;
      
      // Only check goalkeeper position restriction
      const slotRole = slot.dataset.role;
      const playerRole = positionMap[draggedPlayer.position];
      
      // Allow drag-over for all positions, but show visual feedback
      if (slotRole === 'GK' && playerRole === 'GK') {
        slot.classList.add('drag-over');
      } else if (slotRole === 'OUTFIELD' && playerRole !== 'GK') {
        slot.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      const slot = e.currentTarget;
      slot.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      const slot = e.currentTarget;
      const position = parseInt(slot.dataset.position);
      const slotRole = slot.dataset.role;
      const playerRole = positionMap[draggedPlayer.position];

      // Validate ONLY goalkeeper position restriction
      if (slotRole === 'GK' && playerRole !== 'GK') {
        alert('Only goalkeepers can be placed in the goalkeeper position!');
        return;
      }
      if (slotRole === 'OUTFIELD' && playerRole === 'GK') {
        alert('Goalkeepers can only be placed in the goalkeeper position!');
        return;
      }

      // Check if slot is occupied
      if (pitchPlayers[position]) {
        // Swap players
        const existingPlayer = pitchPlayers[position];
        
        if (draggedFromPosition !== null) {
          // Swap two pitch players
          pitchPlayers[draggedFromPosition] = existingPlayer;
          pitchPlayers[position] = draggedPlayer;
        } else {
          // Move existing to bench, place new
          benchPlayers.push(existingPlayer);
          pitchPlayers[position] = draggedPlayer;
          benchPlayers = benchPlayers.filter(p => p._id !== draggedPlayer._id);
        }
      } else {
        // Place in empty slot
        if (draggedFromPosition !== null) {
          // Moving from another pitch position
          delete pitchPlayers[draggedFromPosition];
        } else {
          // Moving from bench
          benchPlayers = benchPlayers.filter(p => p._id !== draggedPlayer._id);
        }
        pitchPlayers[position] = draggedPlayer;
      }

      // Check if we have exactly 11 players
      const pitchCount = Object.keys(pitchPlayers).length;
      if (pitchCount > 11) {
        alert('Cannot have more than 11 players on the pitch!');
        // Revert
        if (draggedFromPosition !== null) {
          pitchPlayers[draggedFromPosition] = draggedPlayer;
          delete pitchPlayers[position];
        } else {
          benchPlayers.push(draggedPlayer);
          delete pitchPlayers[position];
        }
      }

      renderPitch();
      renderBench();
      updateStats();
    }

    // Update statistics
    function updateStats() {
      const pitchCount = Object.keys(pitchPlayers).length;
      document.getElementById('pitchCount').textContent = pitchCount;

      const counts = { GK: 0, DEF: 0, MID: 0, FWD: 0 };
      Object.values(pitchPlayers).forEach(player => {
        const role = positionMap[player.position];
        counts[role]++;
      });

      document.getElementById('gkCount').textContent = counts.GK;
      document.getElementById('defCount').textContent = counts.DEF;
      document.getElementById('midCount').textContent = counts.MID;
      document.getElementById('fwdCount').textContent = counts.FWD;
      
      // Update save button state
      updateSaveButtonState();
    }

    // Update save button state
    function updateSaveButtonState() {
      const pitchCount = Object.keys(pitchPlayers).length;
      const saveBtn = document.getElementById('saveLineupBtn');
      
      if (pitchCount === 11) {
        saveBtn.classList.add('enabled');
        saveBtn.disabled = false;
      } else {
        saveBtn.classList.remove('enabled');
        saveBtn.disabled = true;
      }
    }

    // Save lineup
    async function saveLineup() {
      const pitchCount = Object.keys(pitchPlayers).length;
      
      if (pitchCount !== 11) {
        alert('Please fill all 11 positions before saving!');
        return;
      }

      const title = prompt('Give your lineup a name (optional):');
      if (title === null) return; // User cancelled

      const positions = [];
      for (let i = 0; i < 11; i++) {
        const player = pitchPlayers[i];
        if (player) {
          positions.push({
            positionIndex: i,
            playerId: player._id,
            playerName: player.name,
            playerNumber: player.squadNumber,
            playerPosition: player.position
          });
        }
      }

      try {
        const response = await fetch('/api/lineups', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            formation: currentFormation,
            positions: positions,
            title: title || `Lineup ${new Date().toLocaleDateString()}`
          })
        });

        if (response.ok) {
          alert('Lineup saved successfully!');
          loadHistory(); // Refresh history
        } else {
          const error = await response.json();
          alert('Failed to save lineup: ' + (error.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Save lineup error:', err);
        alert('Failed to save lineup. Please try again.');
      }
    }

    // Load history
    async function loadHistory() {
      try {
        const response = await fetch('/api/lineups');
        if (response.ok) {
          const lineups = await response.json();
          renderHistory(lineups);
        }
      } catch (err) {
        console.error('Load history error:', err);
      }
    }

    // Render history
    function renderHistory(lineups) {
      const historyMenu = document.getElementById('historyMenu');
      
      if (lineups.length === 0) {
        historyMenu.innerHTML = '<div class="history-empty">No saved lineups yet</div>';
        return;
      }

      historyMenu.innerHTML = lineups.map(lineup => `
        <div class="history-item">
          <div class="history-item-content" onclick="loadLineup('${lineup._id}')">
            <div class="history-item-title">${lineup.title}</div>
            <div class="history-item-date">
              ${new Date(lineup.createdAt).toLocaleString()} - ${lineup.formation}
            </div>
          </div>
          <button class="history-item-delete" onclick="event.stopPropagation(); deleteLineup('${lineup._id}', '${lineup.title.replace(/'/g, "\\'")}')">
            üóëÔ∏è Delete
          </button>
        </div>
      `).join('');
    }

    // Load a specific lineup
    async function loadLineup(lineupId) {
      try {
        const response = await fetch(`/api/lineups/${lineupId}`);
        if (response.ok) {
          const lineup = await response.json();
          
          // Clear current pitch
          Object.values(pitchPlayers).forEach(player => {
            if (!benchPlayers.find(p => p._id === player._id)) {
              benchPlayers.push(player);
            }
          });
          pitchPlayers = {};

          // Load lineup positions
          lineup.positions.forEach(pos => {
            const player = allPlayers.find(p => p._id === pos.playerId);
            if (player) {
              pitchPlayers[pos.positionIndex] = player;
              benchPlayers = benchPlayers.filter(p => p._id !== player._id);
            }
          });

          // Update formation if different
          if (lineup.formation !== currentFormation) {
            currentFormation = lineup.formation;
            document.getElementById('currentFormation').textContent = currentFormation;
            document.querySelectorAll('.formation-btn').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.formation === currentFormation);
            });
          }

          renderPitch();
          renderBench();
          updateStats();
          
          // Close history menu
          document.getElementById('historyMenu').classList.remove('show');
        }
      } catch (err) {
        console.error('Load lineup error:', err);
        alert('Failed to load lineup. Please try again.');
      }
    }

    // Delete a lineup
    async function deleteLineup(lineupId, lineupTitle) {
      if (!confirm(`Are you sure you want to delete "${lineupTitle}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/lineups/${lineupId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Lineup deleted successfully!');
          loadHistory(); // Refresh the history list
        } else {
          const error = await response.json();
          alert('Failed to delete lineup: ' + (error.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Delete lineup error:', err);
        alert('Failed to delete lineup. Please try again.');
      }
    }

    // Toggle history menu
    function toggleHistoryMenu() {
      const menu = document.getElementById('historyMenu');
      menu.classList.toggle('show');
      if (menu.classList.contains('show')) {
        loadHistory();
      }
    }

    // Close history menu when clicking outside
    document.addEventListener('click', (e) => {
      const historyDropdown = document.querySelector('.history-dropdown');
      const historyMenu = document.getElementById('historyMenu');
      if (!historyDropdown.contains(e.target) && historyMenu.classList.contains('show')) {
        historyMenu.classList.remove('show');
      }
    })

    // Event listeners
    function attachEventListeners() {
      // Formation buttons
      document.querySelectorAll('.formation-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.formation-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFormation = btn.dataset.formation;
          document.getElementById('currentFormation').textContent = currentFormation;
          
          // Reset pitch when changing formation
          Object.values(pitchPlayers).forEach(player => benchPlayers.push(player));
          pitchPlayers = {};
          
          renderPitch();
          renderBench();
          updateStats();
        });
      });

      // Position filter
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderBench();
        });
      });

      // Search
      document.getElementById('searchInput').addEventListener('input', () => {
        renderBench();
      });

      // Save lineup button
      document.getElementById('saveLineupBtn').addEventListener('click', saveLineup);

      // History button
      document.getElementById('historyBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        toggleHistoryMenu();
      });
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
